var FileInputAccessor_1;
import { __decorate, __metadata } from "tslib";
import { Directive, ElementRef, forwardRef, HostListener, Input, Renderer2 } from '@angular/core';
import { NG_ASYNC_VALIDATORS, NG_VALUE_ACCESSOR } from '@angular/forms';
import { forkJoin, fromEventPattern, of, ReplaySubject } from 'rxjs';
import { first, map, shareReplay, take } from 'rxjs/operators';
let FileInputAccessor = FileInputAccessor_1 = class FileInputAccessor {
    constructor(_renderer, _elementRef) {
        this._renderer = _renderer;
        this._elementRef = _elementRef;
        this.onChange = (_) => { };
        this.onTouched = () => { };
        this.validator = this.generateAsyncValidator();
    }
    set allowedExt(value) {
        if (typeof value === 'string') {
            value = value + '$';
        }
        if (value instanceof Array) {
            value = value.join('|') + '$';
        }
        this._allowedExt = value;
    }
    get allowedExt() {
        return this._allowedExt;
    }
    writeValue(value) {
        this._renderer.setProperty(this._elementRef.nativeElement, 'value', null);
    }
    registerOnChange(fn) {
        this.onChange = this.onChangeGenerator(fn);
    }
    registerOnTouched(fn) { }
    setDisabledState(isDisabled) {
        this._renderer.setProperty(this._elementRef.nativeElement, 'disabled', isDisabled);
    }
    validate(c) {
        return this.validator(c);
    }
    /**
     * Generator method that I used to move the code for the AsyncValidator down here so it didn't
     * get in my way, way up there ^.
     */
    generateAsyncValidator() {
        return (c) => {
            if (!c.value || !c.value.length || c.disabled)
                return of({});
            const errors = {};
            const loaders = [];
            for (const f of c.value) {
                if (this.size && this.size < f.size) {
                    f.errors.fileSize = true;
                    errors.fileSize = true;
                }
                if (f.isImg && (this.maxWidth || this.maxHeight || this.minWidth || this.minHeight)) {
                    loaders.push(f.imgLoadReplay
                        .pipe(take(1), map((e) => {
                        const minWidthError = this.minWidth && f.imgWidth < this.minWidth;
                        const minHeightError = this.minHeight && f.imgHeight < this.minHeight;
                        const maxWidthError = this.maxWidth && f.imgWidth > this.maxWidth;
                        const maxHeightError = this.maxHeight && f.imgHeight > this.maxHeight;
                        if (minWidthError) {
                            f.errors.minWidth = true;
                            errors.minWidth = true;
                        }
                        if (minHeightError) {
                            f.errors.minHeight = true;
                            errors.minHeight = true;
                        }
                        if (maxWidthError) {
                            f.errors.maxWidth = true;
                            errors.maxWidth = true;
                        }
                        if (maxHeightError) {
                            f.errors.maxHeight = true;
                            errors.maxHeight = true;
                        }
                        /** will be @deprecated **/
                        if (minWidthError || maxWidthError) {
                            f.errors.imageWidth = true;
                            errors.imageWidth = true;
                        }
                        /** will be @deprecated **/
                        if (minHeightError || maxHeightError) {
                            f.errors.imageHeight = true;
                            errors.imageHeight = true;
                        }
                        return e;
                    })));
                }
                if (!this.allowedExt && !this.allowedTypes)
                    continue;
                const extP = this.generateRegExp(this.allowedExt);
                const typeP = this.generateRegExp(this.allowedTypes);
                if (extP && !extP.test(f.name)) {
                    f.errors.fileExt = true;
                    errors.fileExt = true;
                }
                if (typeP && !typeP.test(f.type)) {
                    f.errors.fileType = true;
                    errors.fileType = true;
                }
            }
            if (loaders.length) {
                return forkJoin(...loaders).pipe(map(() => errors));
            }
            return of(errors);
        };
    }
    /**
     * Generator method that returns an onChange handler
     */
    onChangeGenerator(fn) {
        return (files) => {
            const fileArr = [];
            for (const f of files) {
                if (this.withMeta && FileReader) {
                    const fr = new FileReader();
                    this.generateFileMeta(f, fr);
                }
                f.errors = {};
                fileArr.push(f);
            }
            fn(fileArr);
        };
    }
    generateRegExp(pattern) {
        if (!pattern)
            return null;
        if (pattern instanceof RegExp) {
            return new RegExp(pattern);
        }
        else if (typeof pattern === 'string') {
            return new RegExp(pattern, 'ig');
        }
        else if (pattern instanceof Array) {
            return new RegExp(`(${pattern.join('|')})`, 'ig');
        }
        return null;
    }
    /**
     * The ICustomFile has a ReplaySubject property for text / image files that will emit
     * once the file has been loaded. Might get removed later since I haven't found a use for it yet.
     */
    generateFileMeta(f, fr) {
        if (f.type.match(/text.*/)) {
            f.textLoadReplay = this.setText(f, fr);
        }
        else if (f.type.match(/image.*/)) {
            f.imgLoadReplay = this.setImage(f, fr);
        }
    }
    setImage(f, fr) {
        f.isImg = true;
        const img = new Image();
        const imgLoadObs = fromEventPattern(((handler) => img.addEventListener('load', handler)), ((handler) => img.removeEventListener('load', handler))).pipe(take(1), shareReplay());
        const frLoadObs = fromEventPattern(((handler) => fr.addEventListener('load', handler)), ((handler) => fr.removeEventListener('load', handler))).pipe(take(1), shareReplay());
        const onloadReplay = new ReplaySubject(1);
        forkJoin(imgLoadObs, frLoadObs).pipe(first()).subscribe(onloadReplay);
        imgLoadObs.pipe(first()).subscribe(() => {
            f.imgHeight = img.height;
            f.imgWidth = img.width;
        });
        frLoadObs.pipe(first()).subscribe(() => {
            f.imgSrc = fr.result + '';
            img.src = fr.result + '';
        });
        fr.readAsDataURL(f);
        return onloadReplay;
    }
    setText(f, fr) {
        const frLoadObs = fromEventPattern(((handler) => fr.addEventListener('load', handler)), ((handler) => fr.removeEventListener('load', handler))).pipe(take(1), shareReplay());
        const onloadReplay = new ReplaySubject(1);
        frLoadObs.subscribe(onloadReplay);
        frLoadObs.pipe(first()).subscribe(() => {
            f.textContent = fr.result + '';
        });
        fr.readAsText(f);
        return onloadReplay;
    }
};
FileInputAccessor.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef }
];
__decorate([
    Input(),
    __metadata("design:type", Object)
], FileInputAccessor.prototype, "allowedTypes", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], FileInputAccessor.prototype, "size", void 0);
__decorate([
    Input(),
    __metadata("design:type", Boolean)
], FileInputAccessor.prototype, "withMeta", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], FileInputAccessor.prototype, "maxHeight", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], FileInputAccessor.prototype, "maxWidth", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], FileInputAccessor.prototype, "minHeight", void 0);
__decorate([
    Input(),
    __metadata("design:type", Number)
], FileInputAccessor.prototype, "minWidth", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], FileInputAccessor.prototype, "allowedExt", null);
__decorate([
    HostListener('change', ['$event.target.files']),
    __metadata("design:type", Object)
], FileInputAccessor.prototype, "onChange", void 0);
__decorate([
    HostListener('blur'),
    __metadata("design:type", Object)
], FileInputAccessor.prototype, "onTouched", void 0);
FileInputAccessor = FileInputAccessor_1 = __decorate([
    Directive({
        selector: 'input[type=file][formControl],input[type=file][formControlName],input[type=file][ngModel]',
        providers: [
            {
                provide: NG_VALUE_ACCESSOR,
                useExisting: forwardRef(() => FileInputAccessor_1),
                multi: true
            },
            {
                provide: NG_ASYNC_VALIDATORS,
                useExisting: forwardRef(() => FileInputAccessor_1),
                multi: true
            }
        ]
    }),
    __metadata("design:paramtypes", [Renderer2, ElementRef])
], FileInputAccessor);
export { FileInputAccessor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS1pbnB1dC1hY2Nlc3Nvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2ZpbGUtaW5wdXQtYWNjZXNzb3IvIiwic291cmNlcyI6WyJsaWIvZmlsZS1pbnB1dC1hY2Nlc3Nvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNoRyxPQUFPLEVBTUgsbUJBQW1CLEVBQ25CLGlCQUFpQixFQUVwQixNQUFNLGdCQUFnQixDQUFDO0FBRXhCLE9BQU8sRUFBQyxRQUFRLEVBQUUsZ0JBQWdCLEVBQWMsRUFBRSxFQUFFLGFBQWEsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUMvRSxPQUFPLEVBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFtQjdELElBQWEsaUJBQWlCLHlCQUE5QixNQUFhLGlCQUFpQjtJQXFDMUIsWUFBb0IsU0FBb0IsRUFBVSxXQUF1QjtRQUFyRCxjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQVUsZ0JBQVcsR0FBWCxXQUFXLENBQVk7UUFIeEIsYUFBUSxHQUFHLENBQUMsQ0FBTSxFQUFFLEVBQUUsR0FBRSxDQUFDLENBQUM7UUFDckQsY0FBUyxHQUFHLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQztRQUd2QyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO0lBQ25ELENBQUM7SUF2QkQsSUFBSSxVQUFVLENBQUMsS0FBaUM7UUFDNUMsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDM0IsS0FBSyxHQUFHLEtBQUssR0FBRyxHQUFHLENBQUM7U0FDdkI7UUFDRCxJQUFJLEtBQUssWUFBWSxLQUFLLEVBQUU7WUFDeEIsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxD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bURBU1A7QUFVZ0Q7SUFBaEQsWUFBWSxDQUFDLFFBQVEsRUFBRSxDQUFDLHFCQUFxQixDQUFDLENBQUM7O21EQUEyQjtBQUNyRDtJQUFyQixZQUFZLENBQUMsTUFBTSxDQUFDOztvREFBc0I7QUFuQ2xDLGlCQUFpQjtJQWY3QixTQUFTLENBQUM7UUFDUCxRQUFRLEVBQUUsMkZBQTJGO1FBQ3JHLFNBQVMsRUFBRTtZQUNQO2dCQUNJLE9BQU8sRUFBRSxpQkFBaUI7Z0JBQzFCLFdBQVcsRUFBRSxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsbUJBQWlCLENBQUM7Z0JBQ2hELEtBQUssRUFBRSxJQUFJO2FBQ2Q7WUFDRDtnQkFDSSxPQUFPLEVBQUUsbUJBQW1CO2dCQUM1QixXQUFXLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLG1CQUFpQixDQUFDO2dCQUNoRCxLQUFLLEVBQUUsSUFBSTthQUNkO1NBQ0o7S0FDSixDQUFDO3FDQXNDaUMsU0FBUyxFQUF1QixVQUFVO0dBckNoRSxpQkFBaUIsQ0F5UDdCO1NBelBZLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RGlyZWN0aXZlLCBFbGVtZW50UmVmLCBmb3J3YXJkUmVmLCBIb3N0TGlzdGVuZXIsIElucHV0LCBSZW5kZXJlcjJ9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgICBBYnN0cmFjdENvbnRyb2wsXG4gICAgQXN5bmNWYWxpZGF0b3IsXG4gICAgQXN5bmNWYWxpZGF0b3JGbixcbiAgICBDb250cm9sVmFsdWVBY2Nlc3NvcixcbiAgICBGb3JtQ29udHJvbCxcbiAgICBOR19BU1lOQ19WQUxJREFUT1JTLFxuICAgIE5HX1ZBTFVFX0FDQ0VTU09SLFxuICAgIFZhbGlkYXRpb25FcnJvcnNcbn0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuXG5pbXBvcnQge2ZvcmtKb2luLCBmcm9tRXZlbnRQYXR0ZXJuLCBPYnNlcnZhYmxlLCBvZiwgUmVwbGF5U3ViamVjdH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2ZpcnN0LCBtYXAsIHNoYXJlUmVwbGF5LCB0YWtlfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0lDdXN0b21GaWxlfSBmcm9tICcuL2ludGVyZmFjZXMnO1xuXG5cbkBEaXJlY3RpdmUoe1xuICAgIHNlbGVjdG9yOiAnaW5wdXRbdHlwZT1maWxlXVtmb3JtQ29udHJvbF0saW5wdXRbdHlwZT1maWxlXVtmb3JtQ29udHJvbE5hbWVdLGlucHV0W3R5cGU9ZmlsZV1bbmdNb2RlbF0nLFxuICAgIHByb3ZpZGVyczogW1xuICAgICAgICB7XG4gICAgICAgICAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICAgICAgICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IEZpbGVJbnB1dEFjY2Vzc29yKSxcbiAgICAgICAgICAgIG11bHRpOiB0cnVlXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICAgIHByb3ZpZGU6IE5HX0FTWU5DX1ZBTElEQVRPUlMsXG4gICAgICAgICAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBGaWxlSW5wdXRBY2Nlc3NvciksXG4gICAgICAgICAgICBtdWx0aTogdHJ1ZVxuICAgICAgICB9XG4gICAgXVxufSlcbmV4cG9ydCBjbGFzcyBGaWxlSW5wdXRBY2Nlc3NvciBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBBc3luY1ZhbGlkYXRvciB7XG4gICAgQElucHV0KCkgYWxsb3dlZFR5cGVzOiBSZWdFeHAgfCBzdHJpbmcgfCBzdHJpbmdbXTtcblxuICAgIEBJbnB1dCgpIHNpemU6IG51bWJlcjtcblxuICAgIEBJbnB1dCgpIHdpdGhNZXRhOiBib29sZWFuO1xuXG4gICAgQElucHV0KCkgbWF4SGVpZ2h0OiBudW1iZXI7XG5cbiAgICBASW5wdXQoKSBtYXhXaWR0aDogbnVtYmVyO1xuXG4gICAgQElucHV0KCkgbWluSGVpZ2h0OiBudW1iZXI7XG5cbiAgICBASW5wdXQoKSBtaW5XaWR0aDogbnVtYmVyO1xuXG4gICAgQElucHV0KClcbiAgICBzZXQgYWxsb3dlZEV4dCh2YWx1ZTogUmVnRXhwIHwgc3RyaW5nIHwgc3RyaW5nW10pIHtcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUgKyAnJCc7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuam9pbignfCcpICsgJyQnO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2FsbG93ZWRFeHQgPSB2YWx1ZTtcbiAgICB9XG5cbiAgICBnZXQgYWxsb3dlZEV4dCgpOiBSZWdFeHAgfCBzdHJpbmcgfCBzdHJpbmdbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9hbGxvd2VkRXh0O1xuICAgIH1cblxuICAgIHZhbGlkYXRvcjogQXN5bmNWYWxpZGF0b3JGbjtcblxuICAgIHByaXZhdGUgX2FsbG93ZWRFeHQ6IFJlZ0V4cCB8IHN0cmluZyB8IHN0cmluZ1tdO1xuXG4gICAgQEhvc3RMaXN0ZW5lcignY2hhbmdlJywgWyckZXZlbnQudGFyZ2V0LmZpbGVzJ10pIG9uQ2hhbmdlID0gKF86IGFueSkgPT4ge307XG4gICAgQEhvc3RMaXN0ZW5lcignYmx1cicpIG9uVG91Y2hlZCA9ICgpID0+IHt9O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfcmVuZGVyZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBfZWxlbWVudFJlZjogRWxlbWVudFJlZikge1xuICAgICAgICB0aGlzLnZhbGlkYXRvciA9IHRoaXMuZ2VuZXJhdGVBc3luY1ZhbGlkYXRvcigpO1xuICAgIH1cblxuICAgIHdyaXRlVmFsdWUodmFsdWU6IGFueSkge1xuICAgICAgICB0aGlzLl9yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICd2YWx1ZScsIG51bGwpO1xuICAgIH1cblxuICAgIHJlZ2lzdGVyT25DaGFuZ2UoZm46IChfOiBhbnkpID0+IHt9KTogdm9pZCB7XG4gICAgICAgIHRoaXMub25DaGFuZ2UgPSB0aGlzLm9uQ2hhbmdlR2VuZXJhdG9yKGZuKTtcbiAgICB9XG5cbiAgICByZWdpc3Rlck9uVG91Y2hlZChmbjogKCkgPT4ge30pOiB2b2lkIHt9XG5cbiAgICBzZXREaXNhYmxlZFN0YXRlKGlzRGlzYWJsZWQ6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAnZGlzYWJsZWQnLCBpc0Rpc2FibGVkKTtcbiAgICB9XG5cbiAgICB2YWxpZGF0ZShjOiBBYnN0cmFjdENvbnRyb2wpOiBPYnNlcnZhYmxlPFZhbGlkYXRpb25FcnJvcnMgfCBudWxsPiB8IFByb21pc2U8VmFsaWRhdGlvbkVycm9ycyB8IG51bGw+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdG9yKGMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdlbmVyYXRvciBtZXRob2QgdGhhdCBJIHVzZWQgdG8gbW92ZSB0aGUgY29kZSBmb3IgdGhlIEFzeW5jVmFsaWRhdG9yIGRvd24gaGVyZSBzbyBpdCBkaWRuJ3RcbiAgICAgKiBnZXQgaW4gbXkgd2F5LCB3YXkgdXAgdGhlcmUgXi5cbiAgICAgKi9cbiAgICBwcml2YXRlIGdlbmVyYXRlQXN5bmNWYWxpZGF0b3IoKTogQXN5bmNWYWxpZGF0b3JGbiB7XG4gICAgICAgIHJldHVybiAoYzogRm9ybUNvbnRyb2wpOiBPYnNlcnZhYmxlPFZhbGlkYXRpb25FcnJvcnM+ID0+IHtcbiAgICAgICAgICAgIGlmICghYy52YWx1ZSB8fCAhYy52YWx1ZS5sZW5ndGggfHwgYy5kaXNhYmxlZCkgcmV0dXJuIG9mKHt9KTtcblxuICAgICAgICAgICAgY29uc3QgZXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JzID0ge307XG4gICAgICAgICAgICBjb25zdCBsb2FkZXJzOiBSZXBsYXlTdWJqZWN0PFByb2dyZXNzRXZlbnQ+W10gPSBbXTtcblxuICAgICAgICAgICAgZm9yIChjb25zdCBmIG9mIGMudmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaXplICYmIHRoaXMuc2l6ZSA8IGYuc2l6ZSkge1xuICAgICAgICAgICAgICAgICAgICBmLmVycm9ycy5maWxlU2l6ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGVycm9ycy5maWxlU2l6ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGYuaXNJbWcgJiYgKHRoaXMubWF4V2lkdGggfHwgdGhpcy5tYXhIZWlnaHQgfHwgdGhpcy5taW5XaWR0aCB8fCB0aGlzLm1pbkhlaWdodCkpIHtcbiAgICAgICAgICAgICAgICAgICAgbG9hZGVycy5wdXNoKFxuICAgICAgICAgICAgICAgICAgICAgICAgZi5pbWdMb2FkUmVwbGF5XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcCgoZTogUHJvZ3Jlc3NFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWluV2lkdGhFcnJvciA9IHRoaXMubWluV2lkdGggJiYgZi5pbWdXaWR0aCA8IHRoaXMubWluV2lkdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtaW5IZWlnaHRFcnJvciA9IHRoaXMubWluSGVpZ2h0ICYmIGYuaW1nSGVpZ2h0IDwgdGhpcy5taW5IZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXhXaWR0aEVycm9yID0gdGhpcy5tYXhXaWR0aCAmJiBmLmltZ1dpZHRoID4gdGhpcy5tYXhXaWR0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1heEhlaWdodEVycm9yID0gdGhpcy5tYXhIZWlnaHQgJiYgZi5pbWdIZWlnaHQgPiB0aGlzLm1heEhlaWdodDtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1pbldpZHRoRXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmLmVycm9ycy5taW5XaWR0aCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLm1pbldpZHRoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1pbkhlaWdodEVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZi5lcnJvcnMubWluSGVpZ2h0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnMubWluSGVpZ2h0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1heFdpZHRoRXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmLmVycm9ycy5tYXhXaWR0aCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLm1heFdpZHRoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1heEhlaWdodEVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZi5lcnJvcnMubWF4SGVpZ2h0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnMubWF4SGVpZ2h0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLyoqIHdpbGwgYmUgQGRlcHJlY2F0ZWQgKiovXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWluV2lkdGhFcnJvciB8fCBtYXhXaWR0aEVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZi5lcnJvcnMuaW1hZ2VXaWR0aCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLmltYWdlV2lkdGggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvKiogd2lsbCBiZSBAZGVwcmVjYXRlZCAqKi9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtaW5IZWlnaHRFcnJvciB8fCBtYXhIZWlnaHRFcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYuZXJyb3JzLmltYWdlSGVpZ2h0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcnMuaW1hZ2VIZWlnaHQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmFsbG93ZWRFeHQgJiYgIXRoaXMuYWxsb3dlZFR5cGVzKSBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGV4dFAgPSB0aGlzLmdlbmVyYXRlUmVnRXhwKHRoaXMuYWxsb3dlZEV4dCk7XG4gICAgICAgICAgICAgICAgY29uc3QgdHlwZVAgPSB0aGlzLmdlbmVyYXRlUmVnRXhwKHRoaXMuYWxsb3dlZFR5cGVzKTtcblxuICAgICAgICAgICAgICAgIGlmIChleHRQICYmICFleHRQLnRlc3QoZi5uYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICBmLmVycm9ycy5maWxlRXh0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgZXJyb3JzLmZpbGVFeHQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICh0eXBlUCAmJiAhdHlwZVAudGVzdChmLnR5cGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGYuZXJyb3JzLmZpbGVUeXBlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgZXJyb3JzLmZpbGVUeXBlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobG9hZGVycy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZm9ya0pvaW4oLi4ubG9hZGVycykucGlwZShtYXAoKCkgPT4gZXJyb3JzKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gb2YoZXJyb3JzKTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZW5lcmF0b3IgbWV0aG9kIHRoYXQgcmV0dXJucyBhbiBvbkNoYW5nZSBoYW5kbGVyXG4gICAgICovXG4gICAgcHJpdmF0ZSBvbkNoYW5nZUdlbmVyYXRvcihmbjogKF86IGFueSkgPT4ge30pOiAoXzogSUN1c3RvbUZpbGVbXSkgPT4gdm9pZCB7XG4gICAgICAgIHJldHVybiAoZmlsZXM6IElDdXN0b21GaWxlW10pID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVBcnI6IEZpbGVbXSA9IFtdO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGYgb2YgZmlsZXMpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy53aXRoTWV0YSAmJiBGaWxlUmVhZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZUZpbGVNZXRhKGYsIGZyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZi5lcnJvcnMgPSB7fTtcbiAgICAgICAgICAgICAgICBmaWxlQXJyLnB1c2goZik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmbihmaWxlQXJyKTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdlbmVyYXRlUmVnRXhwKHBhdHRlcm46IFJlZ0V4cCB8IHN0cmluZyB8IHN0cmluZ1tdKTogUmVnRXhwIHwgbnVsbCB7XG4gICAgICAgIGlmICghcGF0dGVybikgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgaWYgKHBhdHRlcm4gaW5zdGFuY2VvZiBSZWdFeHApIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUmVnRXhwKHBhdHRlcm4pO1xuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYXR0ZXJuID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAocGF0dGVybiwgJ2lnJyk7XG4gICAgICAgIH0gZWxzZSBpZiAocGF0dGVybiBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFJlZ0V4cChgKCR7cGF0dGVybi5qb2luKCd8Jyl9KWAsICdpZycpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoZSBJQ3VzdG9tRmlsZSBoYXMgYSBSZXBsYXlTdWJqZWN0IHByb3BlcnR5IGZvciB0ZXh0IC8gaW1hZ2UgZmlsZXMgdGhhdCB3aWxsIGVtaXRcbiAgICAgKiBvbmNlIHRoZSBmaWxlIGhhcyBiZWVuIGxvYWRlZC4gTWlnaHQgZ2V0IHJlbW92ZWQgbGF0ZXIgc2luY2UgSSBoYXZlbid0IGZvdW5kIGEgdXNlIGZvciBpdCB5ZXQuXG4gICAgICovXG4gICAgcHJpdmF0ZSBnZW5lcmF0ZUZpbGVNZXRhKGY6IElDdXN0b21GaWxlLCBmcjogRmlsZVJlYWRlcikge1xuICAgICAgICBpZiAoZi50eXBlLm1hdGNoKC90ZXh0LiovKSkge1xuICAgICAgICAgICAgZi50ZXh0TG9hZFJlcGxheSA9IHRoaXMuc2V0VGV4dChmLCBmcik7XG4gICAgICAgIH0gZWxzZSBpZiAoZi50eXBlLm1hdGNoKC9pbWFnZS4qLykpIHtcbiAgICAgICAgICAgIGYuaW1nTG9hZFJlcGxheSA9IHRoaXMuc2V0SW1hZ2UoZiwgZnIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRJbWFnZShmOiBJQ3VzdG9tRmlsZSwgZnI6IEZpbGVSZWFkZXIpOiBSZXBsYXlTdWJqZWN0PFtFdmVudCwgUHJvZ3Jlc3NFdmVudF0+IHtcbiAgICAgICAgZi5pc0ltZyA9IHRydWU7XG5cbiAgICAgICAgY29uc3QgaW1nID0gbmV3IEltYWdlKCk7XG5cbiAgICAgICAgY29uc3QgaW1nTG9hZE9icyA9IGZyb21FdmVudFBhdHRlcm48RXZlbnQ+KFxuICAgICAgICAgICAgKChoYW5kbGVyOiBhbnkpID0+IGltZy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgaGFuZGxlcikpLFxuICAgICAgICAgICAgKChoYW5kbGVyOiBhbnkpID0+IGltZy5yZW1vdmVFdmVudExpc3RlbmVyKCdsb2FkJywgaGFuZGxlcikpXG4gICAgICAgICkucGlwZShcbiAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgICBzaGFyZVJlcGxheSgpXG4gICAgICAgICk7XG5cbiAgICAgICAgY29uc3QgZnJMb2FkT2JzID0gZnJvbUV2ZW50UGF0dGVybjxQcm9ncmVzc0V2ZW50PihcbiAgICAgICAgICAgICgoaGFuZGxlcjogYW55KSA9PiBmci5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgaGFuZGxlcikpLFxuICAgICAgICAgICAgKChoYW5kbGVyOiBhbnkpID0+IGZyLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2xvYWQnLCBoYW5kbGVyKSlcbiAgICAgICAgKS5waXBlKFxuICAgICAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgICAgIHNoYXJlUmVwbGF5KClcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBvbmxvYWRSZXBsYXkgPSBuZXcgUmVwbGF5U3ViamVjdDxbRXZlbnQsIFByb2dyZXNzRXZlbnRdPigxKTtcbiAgICAgICAgZm9ya0pvaW4oaW1nTG9hZE9icywgZnJMb2FkT2JzKS5waXBlKGZpcnN0KCkpLnN1YnNjcmliZShvbmxvYWRSZXBsYXkpO1xuXG4gICAgICAgIGltZ0xvYWRPYnMucGlwZShmaXJzdCgpKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgZi5pbWdIZWlnaHQgPSBpbWcuaGVpZ2h0O1xuICAgICAgICAgICAgZi5pbWdXaWR0aCA9IGltZy53aWR0aDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZnJMb2FkT2JzLnBpcGUoZmlyc3QoKSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIGYuaW1nU3JjID0gZnIucmVzdWx0ICsgJyc7XG4gICAgICAgICAgICBpbWcuc3JjID0gZnIucmVzdWx0ICsgJyc7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGZyLnJlYWRBc0RhdGFVUkwoZik7XG5cbiAgICAgICAgcmV0dXJuIG9ubG9hZFJlcGxheTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldFRleHQoZjogSUN1c3RvbUZpbGUsIGZyOiBGaWxlUmVhZGVyKTogUmVwbGF5U3ViamVjdDxQcm9ncmVzc0V2ZW50PiB7XG4gICAgICAgIGNvbnN0IGZyTG9hZE9icyA9IGZyb21FdmVudFBhdHRlcm48UHJvZ3Jlc3NFdmVudD4oXG4gICAgICAgICAgICAoKGhhbmRsZXI6IGFueSkgPT4gZnIuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIGhhbmRsZXIpKSxcbiAgICAgICAgICAgICgoaGFuZGxlcjogYW55ICkgPT4gZnIucmVtb3ZlRXZlbnRMaXN0ZW5lcignbG9hZCcsIGhhbmRsZXIpKVxuICAgICAgICApLnBpcGUoXG4gICAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgICAgc2hhcmVSZXBsYXkoKVxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IG9ubG9hZFJlcGxheSA9IG5ldyBSZXBsYXlTdWJqZWN0PFByb2dyZXNzRXZlbnQ+KDEpO1xuICAgICAgICBmckxvYWRPYnMuc3Vic2NyaWJlKG9ubG9hZFJlcGxheSk7XG5cbiAgICAgICAgZnJMb2FkT2JzLnBpcGUoZmlyc3QoKSkuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgIGYudGV4dENvbnRlbnQgPSBmci5yZXN1bHQgKyAnJztcbiAgICAgICAgfSk7XG5cbiAgICAgICAgZnIucmVhZEFzVGV4dChmKTtcblxuICAgICAgICByZXR1cm4gb25sb2FkUmVwbGF5O1xuICAgIH1cbn1cbiJdfQ==